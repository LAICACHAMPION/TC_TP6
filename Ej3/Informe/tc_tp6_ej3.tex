\documentclass[../../tc_tp6_main.tex]{subfiles}

\begin{document}

%capÃ­tulo
\chapter{Dise\~no de VCO}

En esta secci\'on, se propondr\'a una implementaci\'on de un oscilador controlado por tensi\'on, mejor conocido como VCO (por sus siglas en ingl\'es: \textit{voltage-controlled oscillator}). El mismo recibir\'a como entrada una tensi\'on constante de entre 0V y 5V, y producir\'a a la salida una se\~nal senoidal de 1V de amplitud, cuya frecuencia variar\'a linealmente seg\'un la tensi\'on de entrada entre 1kHz y 10kHz. 


\section{Introducci\'on: el VCO}

El VCO es un oscilador electr\'onica cuya frecuencia de salida depende de la tensi\'on de entrada recibida. Entre sus aplicaciones se destacan su uso en los PLLs, as\'i como la generaci\'on de funciones en s\'i misma.\par

Seg\'un la forma de la se\~nal de salida, los VCOs (as\'i como los osciladores en general) pueden categorizarse como:

\begin{itemize}
	\item \underline{arm\'onicos}: la salida es una se\~nal senoidal. Se implementan generalmente con circuitos LC con compensaci\'on de las p\'erdidas  u osciladores de cristal.
	\item \underline{de relajaci\'on}: la salida es una se\~nal triangular o una rampa.
\end{itemize}

En ambos casos, el par\'ametro fundamental de un VCO es su sensibilidad $k$, que es aquella que establece la relaci\'on entre la tensi\'on de la entrada y la frecuencia fundamental de la salida:

\begin{equation}
	f_{OUT} = k V_{IN}
\end{equation}

Otras caracter\'isticas que pueden resultar de inter\'es en un VCO refieren, en cambio, a la calidad de la salida:

\begin{itemize}
	\item \underline{jitter}: indica qu\'e tan estable se mantiene la frecuencia cuando la tensi\'on de entrada se mantiene constante (salvo quiz\'as por el ruido que pueda tener montado la continua de entrada).
	\item \underline{THD (total harmonic distortion)}: indica qu\'e porcentaje de la potencia de la frecuencia fundamental de la salida se encuentra en sus arm\'onicos. Desde ya, este par\'ametro es relevante s\'olo en el caso de que el VCO sea arm\'onico.
\end{itemize}

\newpage

\section{Dise\~no}

En este caso en particular, el VCO que se implementar\'a es el siguiente:


\begin{figure}[H]
	\centering
	\begin{circuitikz}
		\draw
		(5,7) node[op amp, yscale=-1] (oa) {}		
		(10,6.5) node[op amp] (comp) {}			
		(3,1.5) node[npn, xscale=-1](npn){}		
		
		(0,7.5) node[left] {$V_{IN}$}
		(0,7.5) to [short, o-*] (1,7.5) 
		to [R = 10k$\Omega$, -*] (3, 7.5) %node[below]{$\nicefrac{V_{IN}}{2}$}
		to [short] (oa.+)	
		(3, 7.5) to [R, l_=10k$\Omega$] (3, 9.5) node[ground, yscale=-1]{}	
		
		(1, 7.5) to [short] (1, 6.5)
		to [R, l_=$2R$, -*] (3, 6.5) node[above]{$\nicefrac{V_{IN}}{2}$}
		to [short] (oa.-)
		(3, 6.5) to [short, -*, , i^>=$\nicefrac{V_{IN}}{4R}$] (3, 5.5)
		to [R = $R$] (npn.C)
		
		(comp.-) to [short, -*] (oa.out)
		to [short] (oa.out) -- ++ (0, -1.5)
		to [C=$C$] (3, 5.5)
		
		(oa.out) to [short, -o] (6.2, 7.5) node[above]{$V_{TR}$}	
		
		(comp.+) to [short] (8, 6)
		to [short, -*] (8,5)
		to [R, l_=1k$\Omega$] (8,3) node[ground]{}
		
		(8,5) to [vR, l_=5k$\Omega$, -*] (11.5,5)
		to [short, -*] (11.5, 6.5) to [short] (comp.out)
		(11.5, 6.5) to [short, -o] (12, 6.5) node[right]{$V_{SQ}$}
		
		(11.5, 5) to [short] (11.5, 1.5)
		to [R=1k$\Omega$] (npn.B)
		
		(npn.E) node[ground]{}		
	;\end{circuitikz}
	
	\caption{\textit{Voltage-controlled oscillator} con salidas triangular y cuadrada}
\end{figure}

En la entrada no inversora del primer operacional, un divisor resistivo fija una tensi\'on de $\nicefrac{V_{IN}}{2}$, que se ver\'a replicada en el terminal inversor (considerando el operacional como ideal), y por lo tanto entre este terminal y la entrada la corriente ser\'a siempre de $\nicefrac{V_{IN}}{4R}$. Dependiendo de qu\'e ocurra con el transistor, que se est\'a utilizando como \textit{switch}, las consecuencias de esto ser\'an:

\begin{itemize}
	\item si el transistor conduce, por la resistencia $R$ circula $\nicefrac{V_{IN}}{2R}$, y por lo tanto por el capacitor debe aportar $\nicefrac{V_{IN}}{4R}$ desde la salida del operacional a la entrada inversora (nuevamente considerando ideal al \textit{opamp}).
	\item si el transistor no conduce, toda la corriente que llega al terminal no inversor deber\'a seguir por el capacitor, y por lo tanto su valor tambi\'en ser\'a $\nicefrac{V_{IN}}{4R}$, pero en el sentido contrario que en el caso anterior.
\end{itemize}

Utilizando la ecuaci\'on fundamental del capacitor $i_C = C \frac{dV_C}{dt}$, se obtiene que:
\begin{equation}
	\Delta V_C = \pm \frac{V_{IN}}{4RC}\cdot\Delta t
	\label{eq:vc}
\end{equation}

Por lo tanto, la salida del primer operacional es una rampa definida por la ecuaci\'on:

\begin{equation}
	V_{TR} = \frac{V_{IN}}{2} + V_C = \frac{V_{IN}}{2} \cdot (1 \pm \frac{\Delta t}{2RC})
	\label{eq:vtr}	
\end{equation}

Queda entonces definir qu\'e es lo que sucede con la tensi\'on en la base del transistor, puesto que ser\'a esta la que determine si la pendiente de la rampa es positiva o negativa. \par

Esta tensi\'on est\'a controlada por el segundo \textit{opamp}. Por la retroalimentaci\'on positiva identificamos que no cumple otra funci\'on sino la de Schmidt trigger. Como $V_{out} = A_{vol} \cdot (V^+ - V^-)$, pero esta tensi\'on est\'a a su vez limitada por la saturaci\'on del operacional, $V_{SQ}$ tiene s\'olo dos estados estables:

\begin{itemize}
	\item si $V^+ > V_{TR}$, entonces $V_{SQ} = V_{SAT}$, lo cual a su vez fija $V^+$ en una fracci\'on de $V_{SAT}$, cuyo valor depender\'a de la resistencia variable y llamaremos $V_{TH}$ (tensi\'on de trigger high).
	\item si $V^+ < V_{TR}$, entonces $V_{SQ} = -V_{SAT}$. Lo que ocurre con $V^+$ es an\'alogo al caso anterior, de donde se obtiene $V_{TL}$ (tensi\'on de trigger low).
\end{itemize}

Por lo tanto, la rampa descripta por la ecuaci\'on \ref{eq:vtr} cambiar\'a de pendiente positiva a negativa cuando $V_{TR} = V_{TH}$, y viceversa cuando $V_{TR} = V_{TL}$. Reemplazando entonces $\Delta V$ por $V_{TH} - V_{TL}$ y $\Delta t$ por $\frac{1}{2f_0}$, obtenemos que:

\begin{equation}
	f_0 = \frac{V_{IN}}{8\cdot RC\cdot (V_{TH} - V_{TL})}
	\label{eq:frecuencia}
\end{equation}

Si bien hemos cumplido hasta aqu\'i con dise\~nar un VCO, hay una serie de problemas con esta implementaci\'on en cuanto a lo pedido por la consigna, las cuales se enfrentar\'an de la siguiente manera:

\begin{itemize}
	\item Las tensiones de trigger dependen fuertemente de las tensiones de saturaci\'on del \textit{opamp}. Si bien sabemos que si $V_{CC} = 15\mathrm{V}$, $V_{SAT}$ estar\'a alrededor de los 12V, no podemos saber a priori con cu\'anta tensi\'on exacta saturar\'a cada integrado. Incluso si se midiese antes de armar el circuito, si se quemase el integrado habr\'ia que volver a medir y cambiar una de las resistencias del divisor de tensi\'on. Por esta raz\'on se utiliza un preset en esta etapa.
	\item Con esta configuraci\'on, cuando la tensi\'on de entrada es 0V la salida tambi\'en lo es. Esto se contradice con nuestro objetivo de tener siempre salidas de entre 1kHz y 10kHz. Por lo tanto, se efectuar\'a una transformaci\'on lineal tal que cuando $V_{IN} = 0\mathrm{V}$, al VCO se entre con 1V. Como queremos adem\'as que la frecuencia m\'axima sea 10kHz, esto implica que cuando $V_{IN}=5\mathrm{V}$, se deben tener 10V a la entrada del VCO.
	\item Este es un oscilador de relajaci\'on, y no uno arm\'onico como necesitamos. Se necesita, pues, efectuar una conversi\'on de triangular a senoidal. 
\end{itemize}

Dadas estas consideraciones, se eligieron los valores de los componentes:

\begin{equation}
	\left\{
	\begin{aligned}
		C &= 10\mathrm{nF} \\
		R &= 1.25\mathrm{k}\Omega
	\end{aligned}
	\right.
\end{equation}

De esta manera, se puede usar un capacitor multicapa y tener una tolerancia del 5\% con la cual las otras tecnolog\'ias disponibles no cuentan, y los valores de las resistencias $R$ y $2R$ se aproximaron con una \'unica combinaci\'on serie para cada caso.

\newpage

\subsection{Transformaci\'on lineal [0V; 5V] a [1V; 10V]}

Se quiere obtener un circuito que efect\'ue la transformaci\'on lineal:
\begin{equation}
	V_{OUT} = \frac{9}{5} \cdot V_{IN} + 1\mathrm{V} 
	\label{eq:tl}
\end{equation}

Se utiliz\'o entonces un circuito sumador inversor, utlizando $V_{CC} = 15\mathrm{V}$ para generar el \textit{offset}. El mismo se encuentra ilustrado en la figura \ref{fig:sumador}.
\begin{figure}[H]
	\centering
	\begin{circuitikz}
		\draw
		(4,3) node[op amp, yscale=-1](oa){}		
		
		(0,5) node[left]{+15V} 
		to [R, l^=$R_1$, o-] (2.8,5)
		to [short] (oa.+)
		
		(0,3.5) node[left]{$V_{IN}$}
		to [R, l^=$R_2$, o-*] (oa.+)
		
		(oa.-) to [short, -*] (2.8,1.5)
		to [R=$R_4$] (2.8, -0.5) node[ground]{}
		
		(2.8, 1.5) to [R=$R_3$] (5.2, 1.5)
		to [short, -*] (oa.out) 
		to [short, -o] (5.7, 3) node[right] {$V_{OUT}$} 
	;\end{circuitikz}
	\caption{Sumador no inversor}
	\label{fig:sumador}
\end{figure}
 Por superposici\'on se puede obtener que la salida de este circuito es:

\begin{equation}
	V_{OUT} = \left( \frac{1 + \frac{R_3}{R_4}}{R_1 + R_2} \right) \cdot \left( R_1 \cdot V_{IN} + R_2 \cdot 15\mathrm{V}\right)
\end{equation}

Combinando este resultado con el obtenido en \ref{eq:tl}, se obtiene que las relaciones entre los componentes son:

\begin{equation}
	1 + \frac{R_3}{R_4} = \frac{1}{15} \cdot \left( 1 + \frac{R_1}{R_2} \right) = \frac{9}{15} \cdot \left( 1 + \frac{R_2}{R_1} \right)
\end{equation}

Se utilizaron entonces los siguientes valores, utilizando una combinaci\'on serie para $R_2$ y $R_3$:

\begin{equation}
	\left\{ \begin{aligned}
	R_1 &= 33\mathrm{k}\Omega   	&  R_2 &= 1.22\mathrm{k}\Omega   \\
	R_3 &= 13\mathrm{k}\Omega 	&  R_4 &= 15\mathrm{k}\Omega
	 \end{aligned}  \right.
\end{equation}

\newpage 

\subsection{Conversor triangular a senoidal}

Si bien una se\~nal triangular puede convertirse en una senoidal mediante un filtro apropiado, en este caso es de inter\'es que este proceso sea independiente de la frecuencia. Por lo tanto, se utiliz\'o el circuito de la figura

\begin{figure}[H]
	\centering
	\begin{circuitikz}
		\draw
		(5,5) node[npn](n1){}		
		(8,5) node[npn, xscale=-1](n2){}		

		(1.5, 5) node[left]{$V_{TR}$}
		to [vR=100k$\Omega$, o-*] (4, 5) 
		to [R, l_=2.2k$\Omega$] (4, 3) node[ground]{}
		(4,5) to [short] (n1.B)		
		
		(n1.E) to [short, -*] (5, 3.5)
		to [R=390R, -*] (8,3.5)
		to (n2.E)
		
		(5, 3.5) to [short] (5, 1.5)
		to [R=100k$\Omega$] (8,1.5)
		to [short] (8, 3.5)
		
		(6.5, -1) node[below]{$V_{EE}$}
		to [R=18k$\Omega$, o-] (6.5, 1.3) node[inputarrow, rotate=90]{}
		
 		(n2.B) to [short, -*] (9,5)
 		to [R=2.2k$\Omega$] (9,3) node[ground]{}
 		
 		(n1.C) to [R=10k$\Omega$] (5,8.5)
 		to [short] (8,8.5)
 		to [R=10k$\Omega$] (n2.C)
 		
 		(6.5,8.5) to [short, *-o] (6.5, 9) node[above]{$V_{CC}$}
 		
 		(11,6) node [op amp, scale=0.5](oa) {}
 		(oa.+) to [short, -*] (8, 5.75)
 		(oa.-) to [short, -*] (5, 6.25) 		
 		(oa.+) to [short] (10, 5.75) node[ground]{}
 		
		(oa.-) to [short] (10, 6.25)
		to [short, *-] (10, 7)
		to [vR=5k$\Omega$] (12,7)
		to [short, -*] (12, 6) 
		to [short, -o] (12.5,6) node [right]{$V_{OUT}$} 		
 		(oa.out) to [short] (12,6)
 		
	;\end{circuitikz}
	
	\caption{Conversor de onda triangular a senoidal}
	\label{fig:pardif}
\end{figure}

\section{Resultados}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.71]{imagenes/tc_tp6_ej3_tl.jpg}
	\caption{Transferencia de la transformaci\'on lineal}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.71]{imagenes/tc_tp6_ej3_st.png}
	\caption{Transferencia del Schmidt trigger}
\end{figure}

\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|}
	\hline
	\begin{tabular}[c]{@{}c@{}}Frecuencia\\   fundamental (kHz)\end{tabular} 	& THD (\%)	\\ \hline \hline
	1.11                                                                     					& 0.846    		\\ \hline
	2.92                                                                     					& 0.405    		\\ \hline
	4.98                                                                    					& 0.252    		\\ \hline
	6.21                                                                     					& 0.307   		\\ \hline
	7.68                                                                    					& 1.023    		\\ \hline
	10.0                                                                     					& 1.478    		\\ \hline
	\end{tabular}
	\caption{Distorsi\'on arm\'onica de la salida a distintas frecuencias}
\end{table}


\begin{table}[H]
	\centering
	\begin{tabular}{|c||c|c|c|c|}
	\hline
	$V_{IN}$ (V) 	& Frecuencia media (kHz) 	& M\'inima (kHz) 	& M\'axima (kHz) 	& Desviaci\'on est\'andar (kHz) 	\\ \hline \hline
	0.0          		& 1.12                   		& 1.12                      	& 1.13                      	& $2.10\times 10^{-03}$           	\\ \hline
	1.1          		& 3.22                   		& 3.21                      	& 3.23                      	& $6.60\times 10^{-03}$           	\\ \hline
	2.0          		& 4.88                   		& 4.85                      	& 4.90                      	& $4.70\times 10^{-03}$           	\\ \hline
	3.1          		& 6.76                   		& 6.71                     	& 6.80                      	& $1.50\times 10^{-02}$           	\\ \hline
	4.1          		& 8.49                   		& 8.40                      	& 8.60                      	& $2.40\times 10^{-02}$          	\\ \hline
	5.0          		& 10.1                   		& 10.0                      	& 10.2                      	& $4.40\times 10^{-02}$           	\\ \hline
	\end{tabular}
	\caption{\textit{Jitter} de la salida para distintas tensiones de entrada}
\end{table}



\section{Conclusiones}

DIO TODO IMPECABLE VIEJA NI NO VIMO

\end{document}
